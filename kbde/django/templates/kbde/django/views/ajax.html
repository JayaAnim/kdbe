<div id="ajax-view-{{ view.id }}" class="kbde-ajax-view">
    {% include ajax_content_template_name %}
</div>


<script>
"use strict";
(function(){


var AjaxView = function(element, handle_post){
    var that = this

    this.action_url = "{{ action_url }}"
    this.handle_post = handle_post
    this.$element = $(element)

    this.form_submit_complete = null

    this.form_submit = function(e){
        e.preventDefault()

        var $form = $(this)

        var callback = function(data, text_status, jq_xhr){
            
            if (that.form_submit_complete){
                that.form_submit_complete(data, text_status, jq_xhr)
            }

            if (!that.check_response_path(jq_xhr)){
                window.location.reload()
                return null
            }

            // Place the result back into $element
            that.$element.html(data)
            that.setup()
        }

        that.post($form.serialize(), callback)
    }

    this.load = function(data, complete){
        // https://api.jquery.com/load/

        var callback = function(data, text_status, jq_xhr){

            if (complete){
                complete(data, text_status, jq_xhr)
            }

            if (!that.check_response_path(jq_xhr)){
                window.location.reload()
                return null
            }

            that.$element.html(data)
            that.setup()
        }

        $.get(this.action_url, data, callback)
    }

    this.post = function(data, callback){
        // https://api.jquery.com/jQuery.post/
        $.post(this.action_url, data, callback)
    }

    this.check_response_path = function(jq_xhr){
        var request_url = jq_xhr.getResponseHeader("x-request-url")
        var request_path = request_url.split("?")[0]

        if (!request_path){
            return false
        }

        if (request_path !== this.action_url){
            return false
        }

        return true
    }

    this.setup = function(){

        if (window.kbde && window.kbde.novalidate_forms){
            kbde.novalidate_forms()
        }

        if (this.handle_post){
            this.$forms = this.$element.find("form")
            this.$forms.submit(this.form_submit)
        }
    }

    this.get_id = function(data){
        return this.$element.attr("id")
    }

    this.setup()
}


var AjaxViews = function(){
    
    this.views = {}

    this.add_view = function(ajax_view){
        this.views[ajax_view.get_id()] = ajax_view
    }

    this.get_view_from_element = function(element){
        var $element = $(element)

        if (!$element.hasClass("kbde-ajax-view")){
            $element = $($element.parents(".kbde-ajax-view")[0])
        }

        return this.views[$element.attr("id")]
    }
}


var ajax_views = window.ajax_views || new AjaxViews()
window.ajax_views = ajax_views


var ajax_view = new AjaxView("#ajax-view-{{ view.id }}", {% if handle_post %}true{% else %}false{% endif %})
ajax_views.add_view(ajax_view)


})()
</script>
